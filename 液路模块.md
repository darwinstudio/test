# 液路模块
<!-- TOC -->

- [液路模块](#液路模块)
  - [调试电路板硬件连接](#调试电路板硬件连接)
    - [电机驱动接口](#电机驱动接口)
    - [限位](#限位)
    - [电磁阀](#电磁阀)
    - [串口](#串口)
  - [电机单步动作及参数](#电机单步动作及参数)
    - [清洗蠕动泵](#清洗蠕动泵)
    - [排污蠕动泵](#排污蠕动泵)
    - [采样柱塞泵](#采样柱塞泵)
    - [稀释柱塞泵](#稀释柱塞泵)
    - [取样针Z轴](#取样针z轴)
    - [取样针Y轴](#取样针y轴)
    - [搅拌电机](#搅拌电机)
  - [工作流程](#工作流程)
    - [液路模块整体工作流程](#液路模块整体工作流程)
    - [上电复位流程](#上电复位流程)
    - [液路模块检测流程](#液路模块检测流程)

<!-- /TOC -->
## 调试电路板硬件连接

### 电机驱动接口

| 对应电机     | 接口序号 |
|:--------:|:----:|
| 清洗蠕动泵    | 1    |
| 排污蠕动泵    | 2    |
| 采样柱塞泵    | 3    |
| 稀释柱塞泵    | 4    |
| 取样针Z轴电机  | 5    |
| 取样针Y轴电机  | 6    |
| 搅拌电机     | 7    |

### 限位

| 对应限位     | 接口序号 |
|:--------:|:----:|
| 采样柱塞泵限位  | 1    |
| 稀释柱塞泵限位  | 2    |
| Z轴零点限位   | 4    |
| Y轴零点限位   | 5    |

### 电磁阀

| 对应电磁阀 | 接口序号 |
|:--------:|:----:|
| 稀释电磁阀 | 1    |
| 采样电磁阀  | 2    |

### 串口

| 串口号 | 对应接口         |
|:---:|:------------:|
| 串口1 | 与主板通信        |
| 串口2 | 未使用          |
| 串口3 | TMC2226驱动第一组 |
| 串口4 | 调试口          |
| 串口5 | TMC2226驱动第二组 |

## 电机单步动作及参数

**`此种标记的为参数`**

### 清洗蠕动泵

1. `清洗时间`设置
2. 普通清洗
3. 深度清洗

### 排污蠕动泵

1. 普通排污
2. 深度排污

### 采样柱塞泵

1. 采样柱塞泵复位-复位时液路与取样针相通，取样针需在清洗池位置。`柱塞泵从零点到底部的电机步数`
2. 清洗取样针内壁,`吸取清洗液的量，不超过5毫升`
3. 吸取样本,`吸取样本的量(毫升)`
4. 滴样，`滴样的量(微升)`

### 稀释柱塞泵

1. 稀释柱塞泵复位-复位时液路与稀释针相通，稀释针需要再清洗池位置。`柱塞泵从零点到底部的电机步数`，***此参数和采样泵相同***
2. 稀释样本，`注入试管稀释液的量(毫升)`

### 取样针Z轴

1. Z轴复位，`Z轴从终点到零点的电机步数`
2. Z轴移动到清洗池位置，`清洗池位置Z轴坐标`，***Z轴零点为0，下降为正坐标，取样针针头位置为当前坐标数。例如：Z轴电机从零点下降1000步，此时坐标为1000***
3. Z轴移动到试管稀释位置，`试管稀释位置Z轴坐标`
4. Z轴移动到试管取样位置，`试管取样位置Z轴坐标`
5. Z轴移动到切换针管位置，***不需要参数，此位置是准备滴样位置的相对位置***
6. Z轴移动到准备滴样位置，`移动到准备滴样位置的Z轴坐标`
7. Z轴移动到试剂卡滴样位置，`试剂卡滴样位置的Z轴坐标`
8. Z轴移动到计数板滴样位置，`计数板滴样位置的Z轴坐标`

### 取样针Y轴

1. Y轴复位，`Y轴从终点到零点的电机步数`
2. Y轴移动到清洗池位置，`清洗池位置Y轴坐标`，***Y轴零点为0，终点方向为正坐标，例如：Y轴电机从零点向终点移动1000步，此时坐标为1000***
3. Y轴移动到试管稀释位置，***不需要参数，此位置是试管取样位置的相对位置***
4. Y轴移动到试管取样位置，`试管取样位置Y轴坐标`
5. Y轴移动到试剂卡滴样位置，`试剂卡滴样位置的Y轴坐标`
6. Y轴移动到计数板滴样位置，`计数板滴样位置的Y轴坐标`

### 搅拌电机

1. `搅拌时间`
2. `沉淀时间`
3. 搅拌动作

## 工作流程

### 液路模块整体工作流程

~~~mermaid
graph TD
开始-->上电复位-->waitcmd?{等待主板转发使能命令};
waitcmd?--调试使能-->等待单步命令-->运行指定单步动作-->单步调试完毕-->执行上位机发送的机器复位指令-->工厂调试流程结束-->waitcmd?;
waitcmd?--检测使能-->waitcheck?{等待检测项目通知指令}-->开始检测流程-->over[单个检测流程结束]-->waitcheck?;
over-->waitcmd?;
~~~

### 上电复位流程

~~~mermaid
graph TD
开始-->Z轴复位-->Y轴复位-->Y轴移动到清洗位置-->Z轴下降进入清洗池-->执行清洗程序-->end1[Z轴复位]-->end2[Y轴复位]-->告诉主板复位完成-->流程结束;
subgraph 清洗程序
sample_dilute_reset[采样和稀释柱塞泵复位];
sample_dilute_reset--> sample_wash[采样柱塞泵清洗内壁];
sample_dilute_reset-->wash_unload_work[清洗和排污蠕动泵开始工作];
sample_wash-->wait_all_finish[等待所有清洗完成];
wash_unload_work-->wait_all_finish-->清洗程序完成;
end
~~~

### 液路模块检测流程

~~~mermaid
graph TD
start[开始检测]-->稀释泵开始吸取稀释液;
start-->上报上位机进程:正在稀释-->Y轴移动到样本稀释位置-->Z轴下降到稀释位置-->向样本中注入稀释液-->上报上位机进程:正在搅拌-->搅拌电机搅拌-->上报上位机进程:沉淀等待-->沉淀等待-->上报上位机进程:正在取样-->Z轴上升到切换取样针位置-->Y轴移动到取样位置-->Z轴下降到取样位置-->取样泵吸取样本-->上报上位机进程:正在试剂卡滴样-->zsszbdy[Z轴上升到滴样位置]-->Y轴移动到试剂卡滴样位置-->dropok?{查询试剂卡是否可以滴样?}--可以-->取样泵滴样-->sjkdf[告诉试剂卡模块滴样完成]-->上报上位机进程:正在计数板滴样-->Y轴移动到计数板滴样位置-->dropok2?{查询计数板是否可以滴样?}--可以-->drop2[取样泵滴样]-->告诉镜检模块滴样完成-->istwo?{试剂卡是否是双通道?}--单通道-->上报上位机进程:正在清洗-->执行清洗程序-->液路模块检测流程结束;
dropok?--不可以-->等待;
dropok2?--不可以-->等待;
istwo?--双通道-->Y轴移动到试剂卡滴样位置;
sjkdf==双通道==>上报上位机进程:正在清洗;
~~~
