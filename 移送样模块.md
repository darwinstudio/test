# 移送样模块
<!-- TOC -->

- [移送样模块](#移送样模块)
  - [调试电路板硬件连接](#调试电路板硬件连接)
    - [电机驱动接口](#电机驱动接口)
    - [限位](#限位)
    - [补光灯驱动](#补光灯驱动)
    - [串口](#串口)
  - [电机单步动作及参数](#电机单步动作及参数)
    - [移样电机](#移样电机)
    - [送样电机](#送样电机)
    - [清样电机](#清样电机)
    - [码盘校准步骤](#码盘校准步骤)
    - [扫码枪](#扫码枪)
  - [工作流程](#工作流程)
    - [移送样模块整体流程](#移送样模块整体流程)
    - [上电复位](#上电复位)
    - [检测流程](#检测流程)

<!-- /TOC -->
## 调试电路板硬件连接

### 电机驱动接口

| 对应电机     | 接口序号 |
|:--------:|:----:|
| 移样电机    | 1    |
| 送样电机    | 2    |
| 清样电机    | 3    |

### 限位

| 对应限位     | 接口序号 |
|:--------:|:----:|
| 移样电机零点限位  | 1    |
| 码盘限位  | 2    |
| 送样电机零点限位   | 4    |
| 送样电机终点限位   | 5    |
| 清样电机零点限位   | 6    |
| 移样终点样本架检测传感器      | 7   |
| 试管检测传感器              | 8    |
| 清样台满检测传感器          | 9    |

### 补光灯驱动

| 对应电磁阀 | 接口序号 |
|:--------:|:----:|
| 样本拍照补光灯 | 5    |

### 串口

| 串口号 | 对应接口         |
|:---:|:------------:|
| 串口1 | 与主板通信        |
| 串口2 | 扫码枪          |
| 串口3 | TMC2226驱动第一组 |
| 串口4 | 调试口          |
| 串口5 | TMC2226驱动第二组 |

## 电机单步动作及参数

**`此种颜色标记的为参数`**

### 移样电机

1. 推入试管架，然后返回零点，`移样电机从零点到终点的总步数`

### 送样电机

1. 复位，`送样电机从零点到终点的总步数`
2. 巡航，走一个来回。
3. 送样电机送样本架的第一个样本孔到试管检测位置
4. 送样电机送样本架上的头一个试管到试管检测位置
5. 样本架前进一格,`码盘一个刻度的步数`

### 清样电机

1. 清样动作，`清样动作步数`

### 码盘校准步骤

1. 上位机发送***码盘校准辅助***功能；
2. 送样轨道上放入样本架，样本架中放入试管，调整样本架位置，让试管中心位置对准摄像头和取样针；
3. 松码盘螺丝，调整码盘到缝隙处，蜂鸣器响起即为正确位置。

### 扫码枪

1. 扫码，上报扫码结果。扫码枪应对准样本拍照位置的试管。

## 工作流程

### 移送样模块整体流程

~~~mermaid
graph TD
开始-->上电复位-->waitcmd{等待主板转发使能命令};
waitcmd==下位机收到单步使能==>waitsingle[等待单步命令];


waitsingle-->运行指定单步动作-->单步调试完毕-->执行上位机发送的机器复位指令-->工厂调试流程结束;

工厂调试流程结束-->waitcmd;
waitcmd==下位机收到检测使能==>startcheck[开始检测];


startcheck-->isrude?{移样台是否有样本架?};
isrude?--否-->上报给上位机移样台空-->有样本架了-->开始检测工作;
上报给上位机移样台空-->waitcmd;
isrude?--是-->开始检测工作-->单个样本架检测完毕-->isrude?;

~~~

### 上电复位

~~~mermaid
graph TD
开始-->所有电机复位--> 送样电机巡航--> 清样电机清台-->告诉主板复位完成-->上电复位流程结束;
~~~

### 检测流程

~~~mermaid
graph TD
开始-->checkrude?{检测送样位置是否有样本架?}--否-->上报上位机进程:正在移样-->移样电机推样本架到送样位置-->上报上位机进程:正在送样-->pushtube[送样电机推样本架到检测位置];
isover?--否-->checktube?{是否有试管?}--是-->送样电机推到样本拍照位置-->扫码枪扫码并上报-->等待液路模块取样完成指令-->pushtube;
checkrude?--是-->上报上位机进程:正在送样;
checktube?--否-->pushtube;
pushtube-->isover?{样本孔计数,这个样本架是否检测完毕?}--是-->上报上位机进程:正在清台-->送样电机推到终点-->清样电机清台-->送样电机回到了零点-->单个检测流程结束
~~~
