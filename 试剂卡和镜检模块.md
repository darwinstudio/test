# 试剂卡和镜检模块
<!-- TOC tocDepth:2..3 chapterDepth:2..6 -->

- [试剂卡和镜检模块](#试剂卡和镜检模块)
  - [调试电路板硬件连接](#调试电路板硬件连接)
    - [电机驱动接口](#电机驱动接口)
    - [限位](#限位)
    - [补光灯](#补光灯)
    - [串口](#串口)
  - [电机单步动作及参数](#电机单步动作及参数)
    - [试剂卡X轴](#试剂卡x轴)
    - [试剂卡通道1卡仓](#试剂卡通道1卡仓)
    - [试剂卡通道2卡仓](#试剂卡通道2卡仓)
    - [镜检X轴](#镜检x轴)
    - [镜检Y轴](#镜检y轴)
    - [镜检Z轴](#镜检z轴)
    - [镜检S轴-切换镜头](#镜检s轴-切换镜头)
  - [工作流程](#工作流程)
    - [试剂卡和镜检模块整体流程](#试剂卡和镜检模块整体流程)
    - [上电复位](#上电复位)
    - [试剂卡检测流程](#试剂卡检测流程)
    - [镜检检测流程](#镜检检测流程)

<!-- /TOC -->
## 调试电路板硬件连接

### 电机驱动接口

| 对应电机     | 接口序号 |
|:--------:|:----:|
| 试剂卡X轴    | 1    |
| 试剂卡通道1    | 2    |
| 试剂卡通道2    | 3    |
| 镜检X轴    | 4    |
| 镜检Y轴  | 5    |
| 镜检Z轴  | 6    |
| 镜检切换镜头     | 7    |

### 限位

| 对应限位     | 接口序号 |
|:--------:|:----:|
| 试剂卡X轴零点限位  | 1    |
| 试剂卡通道1零点限位  | 2    |
| 试剂卡通道2零点限位   | 4    |
| 镜检X轴零点限位   | 5    |
| 有无试剂卡检测传感器   | 6    |
| 试剂卡拍照位置检测传感器   | 7    |
| 镜检有无计数板检测传感器   | 8    |
| 镜检Y轴零点限位   | 9    |
| 镜检Z轴零点限位   | 10    |
| 镜检S轴零点限位   | 11    |

### 补光灯

| 对应补光灯 | 接口序号 |
|:--------:|:----:|
| 试剂卡拍照补光灯 | 3    |
| 显微镜拍照补光灯  | 5    |

### 串口

| 串口号 | 对应接口         |
|:---:|:------------:|
| 串口1 | 与上位机通信        |
| 串口2 | 与移送样模块通信          |
| 串口3 | TMC2226驱动第一组 |
| 串口4 | 与液路模块通信          |
| 串口5 | TMC2226驱动第二组 |

## 电机单步动作及参数

**`此种标记的为参数`**

### 试剂卡X轴

1. 试剂卡X轴清台，`试剂卡X轴从零点到拍照位置的总步数`
2. 试剂卡X轴移动到滴样位置,`试剂卡X轴从零点到滴样位置的步数`
3. 试剂卡X轴复位
4. 试剂卡滴样完成，可以进入孵育时间，时间到达后，推到拍照位置后，试剂卡X轴电机复位，结束。**和检测流程的区别是到达拍照位置后，此单步不发送请求拍照命令**`孵育时间设置(秒)`

### 试剂卡通道1卡仓

1. 下降到推卡位置，`试剂卡仓下降步数`
2. 试剂卡通道1卡仓复位

### 试剂卡通道2卡仓

1. 下降到推卡位置，`试剂卡仓下降步数` ***两个通道卡仓共用一个参数***
2. 试剂卡通道2卡仓复位

### 镜检X轴

1. 镜检X轴复位
2. 镜检X轴从零点移动到终点，`镜检X轴从零点到终点的总步数`
3. 镜检X轴移动到滴样位置,`镜检X轴从零点移动到滴样位置的步数`
4. 镜检X轴正向、反向移动步数，***正向即向终点方向移动，反向即向零点方向移动***

### 镜检Y轴

1. 镜检Y轴复位
2. 镜检Y轴移动到终点,`镜检Y轴从零点到终点的总步数`
3. 镜检Y轴正向、反向移动步数

### 镜检Z轴

1. 镜检Z轴复位
2. 镜检Z轴旋转一圈，`镜检Z轴旋转一圈的总步数`
3. 镜检Z轴正向、反向移动步数，***正向即顺时针移动，反向即逆时针移动***

### 镜检S轴-切换镜头

1. 镜检S轴复位，复位位置为高倍镜
2. 镜检S轴切换到低倍镜，`镜检S轴切换镜头的步数`

## 工作流程

### 试剂卡和镜检模块整体流程

~~~mermaid
graph TD
开始-->上电复位-->waitcmd?{等待上位机发送使能命令};
waitcmd?--调试使能-->等待单步命令-->运行指定单步动作-->单步调试完毕-->上位机发送机器复位指令-->工厂调试流程结束-->waitcmd?;
waitcmd?--检测使能-->waitcheck?{等待检测项目通知指令}-->开始检测流程-->over[单个检测流程结束]-->waitcheck?;
over-->waitcmd?;
~~~

### 上电复位

~~~mermaid
graph TD

试剂卡X轴复位-->试剂卡X轴移动到终点清台-->两个试剂卡仓和X轴电机复位;

两个试剂卡仓和X轴电机复位-->waitall[等待机器所有电机复位完成];

镜检所有电机复位-->waitall;
等待移送样模块复位完成信号-->waitall;
等待液路模块复位完成信号-->waitall;
waitall-->上报上位机进程:机器复位完成-->流程结束;
~~~

### 试剂卡检测流程

~~~mermaid
graph TD

reset[X轴电机复位];
chan1down[试剂卡仓降下];
todropp[试剂卡X轴推试剂卡到滴样位置];
start[开始];

start-->上报上位机进程:试剂卡正在推卡到滴样位置-->chan1down-->todropp-->试剂卡仓复位-->issjk?{有试剂卡?}--有-->告诉液路模块可以滴样-->等待液路模块发送试剂卡滴样完成指令-->孵育开始计时-->chanls?{剩余等待滴样的通道数?};

chanls?--大于零-->reset-->上报上位机进程:试剂卡正在推卡到滴样位置;

chanls?--等于零-->fyfinish?{孵育时间到了吗?}--到了-->询问上位机试剂卡相机状态,等待相机可用-->上报上位机进程:正在推卡到试剂卡拍照位置-->试剂卡X轴推试剂卡到拍照位置-->请求上位机试剂卡拍照-->试剂卡X轴电机复位-->hy{孵育队列中还有试剂卡吗?}--有-->fyfinish?;
hy--没有-->试剂卡检测流程结束;

issjk?--没有-->reset1[X轴电机复位]-->上报试剂卡仓空-->等待上位机发送试剂卡补充完成指令-->chan1down;

fyfinish?--没有-->有新的检测命令就开始新的-->没有就等待;
~~~

### 镜检检测流程

~~~mermaid
graph TD
开始-->上报上位机进程:正在推计数板到滴样位置-->镜检X轴推计数板到滴样位置-->hasboard?{有没有计数板?}--有-->告诉液路模块可以滴样-->等待液路发送滴样完成信号-->上报上位机计数板滴样完成-->上位机控制镜检拍照-->等待上位机发送镜检拍照完成指令-->镜检X轴复位-->镜检检测流程结束;
hasboard?--没有-->X轴复位-->上报计数板卡仓空-->等待上位机计数板卡仓补充完毕指令-->镜检X轴推计数板到滴样位置;
~~~
